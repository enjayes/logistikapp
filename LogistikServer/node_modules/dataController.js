/**
 * dataController.
 *
 * >>Description<<
 *
 * @author Manfred
 * @date 21.11.14 - 12:26
 * @copyright munichDev UG
 */


dataController = {
    mysql: null,
    mysqlConnection:null,
    init: function (preferences) {

        //Load mysql
        this.mysql = require('mysql');
        //Connect to MySql database
        this.mysqlConnection =  this.mysql.createConnection(preferences.mysql);
        this.mysqlConnection.connect(function (err) {
            if (err) throw err;
            console.log('Connected to MySql database');
        });
        
        
        
    },
    handleMessage: function (clientController,client, data) {

        console.log("Website: Message " + data.t)
        if (data.t.substr(0, 1) == "l") {
            dataController.lieferant.handleMessage(clientController,client, data)
        } else if (data.t.substr(0, 1) == "t") {
            dataController.termin.handleMessage(clientController,client, data)
        } else if (data.t.substr(0, 1) == "n") {
            dataController.nachricht.handleMessage(clientController,client, data)
        } else if (data.t.substr(0, 1) == "a") {
            dataController.antwortNachricht.handleMessage(clientController,client, data)
        } else  if (data.t.substr(0, 1) == "j") {
            dataController.job.handleMessage(clientController,client, data)
        }


    },

    lieferant: {
        messageType: {
            getAll: "lga",
            create: "lc",
            update: "lu",
            delete: "ld",
            get: "lg",
            updateOthers: "luo"
        },
        convertFromSQL: function (sqlLieferant) {
            return {
                id: sqlLieferant.id,
                vorname: sqlLieferant.Vorname,
                name: sqlLieferant.Name,
                telefon: sqlLieferant.Telefon,
                email: sqlLieferant.EMail,
                adresse: sqlLieferant.Adresse,
                notizen: sqlLieferant.Notizen
            }

        },
        convertToSQL: function (lieferant) {
            return {
                id: lieferant.id,
                Vorname: lieferant.vorname,
                Name: lieferant.name,
                Telefon: lieferant.telefon,
                EMail: lieferant.email,
                Adresse: lieferant.adresse,
                Notizen: lieferant.notizen
            }
        },
        handleMessage: function (clientController,client, data) {
            var lieferant, sqlLieferant;

            if (data.t == this.messageType.getAll) {

                dataController.mysqlConnection.query('SELECT * FROM Lieferanten', function (err, rows, fields) {

                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {

                        if (rows) {

                            var lieferanten = [];
                            for (var i = 0; i < rows.length; i++) {
                                lieferanten.push(dataController.lieferant.convertFromSQL(rows[i]));
                            }
                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: lieferanten});
                        }
                    }
                });

            } else if (data.t == this.messageType.create) {

                lieferant = data.l;
                if (lieferant) {
                    sqlLieferant = dataController.lieferant.convertToSQL(lieferant);
                    dataController.mysqlConnection.query('INSERT INTO Lieferanten SET ?', sqlLieferant, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            dataController.lieferant.informOtherClients(clientController,client);


                        }
                    });
                }
            } else if (data.t == this.messageType.update) {
                lieferant = data.l;

                if (lieferant) {

                    sqlLieferant = dataController.lieferant.convertToSQL(lieferant);
                    dataController.mysqlConnection.query("UPDATE Lieferanten SET ? WHERE id = ? ", [sqlLieferant, sqlLieferant.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.lieferant.informOtherClients(clientController,client);

                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {

                lieferant = data.l;
                if (lieferant) {
                    dataController.mysqlConnection.query('DELETE FROM Lieferanten WHERE id = ?', lieferant.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.lieferant.informOtherClients(clientController,client);


                        }
                    });
                }
            }

        }, informOtherClients: function (clientController,client) {

            if (clientController.clients.length > 1) {


                //Send list of all Lieferanten to ohter clients
                dataController.mysqlConnection.query('SELECT * FROM Lieferanten', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var lieferanten = [];
                            for (var i = 0; i < rows.length; i++) {
                                lieferanten.push(dataController.lieferant.convertFromSQL(rows[i]));
                            }
                            var clients = clientController.clients.filter(function (element) {
                                return (element.socket != client.socket)
                            });

                            clients.forEach(function (actClient) {

                                actClient.socket.emit('message', {t: dataController.lieferant.messageType.updateOthers, l: lieferanten});

                            });


                        }
                    }
                });

            }

        }

    },
    termin: {
        messageType: {
            getAll: "tga",
            create: "tc",
            update: "tu",
            delete: "td",
            get: "tg",
            updateOthers: "tuo"
        },
        convertFromSQL: function (sqlTermin) {

            var newTermin = {
                id: sqlTermin.id,
                title: sqlTermin.Title,
                start: sqlTermin.Start,
                allDay: sqlTermin.AllDay,
                notizen: sqlTermin.Notizen,
                lieferant: sqlTermin.Lieferant

            }

            if (sqlTermin.end != "")
                newTermin.end = sqlTermin.End;
            else
                newTermin.end = undefined;

            return newTermin;
        },
        convertToSQL: function (termin) {

            return {
                id: termin.id,
                Title: termin.title,
                Start: termin.start,
                End: termin.end,
                AllDay: termin.allDay,
                Notizen: termin.notizen,
                Lieferant: termin.lieferant

            }

        },
        handleMessage: function (clientController,client, data) {
            var termin, sqlTermin;

            if (data.t == this.messageType.getAll) {
                dataController.mysqlConnection.query('SELECT * FROM Termine', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var termine = [];
                            for (var i = 0; i < rows.length; i++) {
                                termine.push(dataController.termin.convertFromSQL(rows[i]));
                            }
                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: termine});
                        }
                    }
                });

            } else if (data.t == this.messageType.create) {

                termin = data.l;
                if (termin) {
                    sqlTermin = dataController.termin.convertToSQL(termin);
                    dataController.mysqlConnection.query('INSERT INTO Termine SET ?', sqlTermin, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.termin.informOtherClients(client);

                        }
                    });
                }
            } else if (data.t == this.messageType.update) {
                termin = data.l;

                if (termin) {

                    sqlTermin = dataController.termin.convertToSQL(termin);

                    dataController.mysqlConnection.query("UPDATE Termine SET ? WHERE id = ? ", [sqlTermin, sqlTermin.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.termin.informOtherClients(client);
                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {

                termin = data.l;
                if (termin) {
                    dataController.mysqlConnection.query('DELETE FROM Termine WHERE id = ?', termin.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.termin.informOtherClients(client);
                        }
                    });
                }
            }
        }, informOtherClients: function (clientController,client) {

            if (clientController.clients.length > 1) {


                //Send list of all termine to ohter clients
                dataController.mysqlConnection.query('SELECT * FROM Termine', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var termine = [];
                            for (var i = 0; i < rows.length; i++) {
                                termine.push(dataController.termin.convertFromSQL(rows[i]));
                            }


                            var clients = clientController.clients.filter(function (element) {
                                return (element.socket != client.socket)
                            });

                            clients.forEach(function (actClient) {

                                actClient.socket.emit('message', {t: dataController.termin.messageType.updateOthers, e: termine});

                            });


                        }
                    }
                });

            }

        }
    },

    nachricht: {
        messageType: {
            getAll: "nga",
            create: "nc",
            delete: "nd",
            updateOthers: "nuo"
        },
        convertFromSQL: function (sqlNachricht) {
            return {
                id: sqlNachricht.id,
                datum: parseInt(sqlNachricht.datum),
                nachricht: sqlNachricht.nachricht
            }

        },
        convertToSQL: function (nachricht) {
            return {
                id: nachricht.id,
                datum: nachricht.datum,
                nachricht: nachricht.nachricht
            }
        },
        //Get all the Messages, joins messages and receipients
        getAllAdminNachrichten: function (callback) {
            if (!callback)
                return;
            dataController.mysqlConnection.query('SELECT * FROM Adminnachrichtgesendet ORDER BY datum DESC' , function (err, rows, fields) {
                if (err)
                    console.log("MYSQL ERROR: " + err);
                else {
                    if (rows) {

                        var getLieferanten = function (nachrichten, position) {

                            if (position == nachrichten.length)
                                callback([]);
                            else {
                                nachrichten[position] = dataController.nachricht.convertFromSQL(nachrichten[position]);

                                dataController.mysqlConnection.query('SELECT * FROM Adminlieferantnachricht WHERE nachrichtenid = ?', nachrichten[position].id, function (err, rows, fields) {
                                    if (err)
                                        console.log("MYSQL ERROR: " + err);
                                    else {
                                        if (rows) {

                                            nachrichten[position].lieferanten = [];
                                            for (var i = 0; i < rows.length; i++) {
                                                nachrichten[position].lieferanten.push({lieferantid: rows[i].lieferantid, read: rows[i].read==1?true:false});

                                            }


                                            if (position == nachrichten.length - 1) {
                                                callback(nachrichten)
                                            }
                                            else
                                                getLieferanten(nachrichten, position + 1);
                                        }
                                    }
                                });
                            }
                        }
                        getLieferanten(rows, 0);

                    }
                }
            });
        }, handleMessage: function (clientController,client, data) {

            var nachricht, sqlNachricht;

            if (data.t == this.messageType.getAll) {

                dataController.nachricht.getAllAdminNachrichten(function (nachrichten) {
                    client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: nachrichten});

                })

            } else if (data.t == this.messageType.create) {

                nachricht = data.n;
                if (nachricht) {

                    sqlNachricht = dataController.nachricht.convertToSQL(nachricht);

                    dataController.mysqlConnection.query('INSERT INTO Adminnachrichtgesendet SET ?', sqlNachricht, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            for (var i = 0; i < nachricht.lieferanten.length; i++) {
                                var lieferantId = nachricht.lieferanten[i].lieferantid;
                                var insertData = {lieferantid: lieferantId, nachrichtenid: nachricht.id};
                                dataController.mysqlConnection.query('INSERT INTO Adminlieferantnachricht SET ?', insertData, function (err, result) {
                                    if (err)
                                        console.log("MYSQL ERROR: " + err);
                                    else {

                                        dataController.nachricht.informOtherClients(client);

                                    }
                                });

                            }

                        }
                    });
                }
            } else if (data.t == this.messageType.delete) {

                nachricht = data.n;
                if (nachricht) {
                    dataController.mysqlConnection.query('DELETE FROM Adminnachrichtgesendet WHERE id = ?', nachricht.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            dataController.mysqlConnection.query('DELETE FROM Adminlieferantnachricht WHERE nachrichtenid = ?', nachricht.id, function (err, result) {
                                if (err)
                                    console.log("MYSQL ERROR: " + err);
                                else {

                                    dataController.nachricht.informOtherClients(client);

                                }
                            });
                        }
                    });
                }


            }
        }, informOtherClients: function (clientController,client) {

            if (clientController.clients.length > 1) {

                dataController.nachricht.getAllAdminNachrichten(function (nachrichten) {

                    var clients = clientController.clients.filter(function (element) {
                        return (element.socket != client.socket)
                    });

                    clients.forEach(function (actClient) {
                        actClient.socket.emit('message', {t: dataController.nachricht.messageType.updateOthers, n: nachrichten});
                    });

                })


            }

        }

    },
    antwortNachricht: {
        messageType: {
            getAll: "aga",
            update: "au",
            delete: "ad",
            updateOthers: "auo"
        },
        convertFromSQL: function (sqlNachricht) {

            return {
                id: sqlNachricht.id,
                lieferantid: sqlNachricht.lieferantid,

                read: sqlNachricht.read==1?true:false,

                datum: parseInt(sqlNachricht.datum),

                nachricht: sqlNachricht.nachricht
            }

        },
        convertToSQL: function (nachricht) {
            return {
                id: nachricht.id,
                lieferantid: nachricht.lieferantid,
                read: nachricht.read==true?1:0,
                datum: nachricht.datum,
                nachricht: nachricht.nachricht
            }
        },
        getAllAdminNachrichten: function (callback) {
            if (!callback)
                return;
            dataController.mysqlConnection.query('SELECT * FROM Lieferantnachrichtgesendet  ORDER BY datum DESC', function (err, rows, fields) {
                if (err)
                    console.log("MYSQL ERROR: " + err);
                else {
                    if (rows) {

                        var nachrichten = [];
                        for (var i = 0; i < rows.length; i++) {
                            nachrichten.push(dataController.antwortNachricht.convertFromSQL(rows[i]));
                        }
                        callback(nachrichten);
                    }
                }
            });


        },
        handleMessage: function (clientController,client, data) {

            var nachricht, sqlNachricht;

            if (data.t == this.messageType.getAll) {
                dataController.antwortNachricht.getAllAdminNachrichten(function(nachrichten){
                    client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: nachrichten});
                })

            } else if (data.t == this.messageType.update) {
                nachricht = data.a;
                if (nachricht) {

                    sqlNachricht = dataController.antwortNachricht.convertToSQL(nachricht);

                    dataController.mysqlConnection.query("UPDATE Lieferantnachrichtgesendet SET ? WHERE id = ? ", [sqlNachricht, sqlNachricht.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.antwortNachricht.informOtherClients(client);
                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {


                nachricht = data.a;
                if (nachricht) {
                    dataController.mysqlConnection.query('DELETE FROM Lieferantnachrichtgesendet WHERE id = ?', nachricht.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.antwortNachricht.informOtherClients(client);
                        }
                    });
                }


            }
        }, informOtherClients: function (clientController,client) {

            if (clientController.clients.length > 1) {

                dataController.antwortNachricht.getAllAdminNachrichten(function (nachrichten) {

                    var clients = clientController.clients.filter(function (element) {
                        return (element.socket != client.socket)
                    });

                    clients.forEach(function (actClient) {
                        actClient.socket.emit('message', {t: dataController.antwortNachricht.messageType.updateOthers, a: nachrichten});
                    });

                })


            }

        }
    }
    ,job: {
        messageType: {
            getAll: "jga",
            create: "jc",
            update: "ju",
            delete: "jd",
            get: "jg",
            updateOthers: "juo"
        },
        convertFromSQL: function (sqlJob) {
            return {
                id: sqlJob.id
                //TODO
            }

        },
        convertToSQL: function (job) {
            return {
                id: job.id
                //TODO
            }
        },
        handleMessage: function (clientController,client, data) {
            var job, sqlJob;



            if (data.t == this.messageType.getAll) {
                //Fake Database---------------------------
                var jobs = [{id:"testid1"},{id:"testid2"}];
                client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: jobs});
                return;
                //----------------------------------------

                dataController.mysqlConnection.query('SELECT * FROM Jobs', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var jobs = [];
                            for (var i = 0; i < rows.length; i++) {
                                jobs.push(dataController.job.convertFromSQL(rows[i]));
                            }

                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: jobs});
                        }
                    }
                });

            } else if (data.t == this.messageType.create) {

                job = data.j;
                if (job) {
                    sqlJob = dataController.job.convertToSQL(job);
                    dataController.mysqlConnection.query('INSERT INTO Jobs SET ?', sqlJob, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            dataController.job.informOtherClients(client);


                        }
                    });
                }
            } else if (data.t == this.messageType.update) {
                job = data.j;

                if (job) {

                    sqlJob = dataController.job.convertToSQL(job);
                    dataController.mysqlConnection.query("UPDATE Jobs SET ? WHERE id = ? ", [sqlJob, sqlJob.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.job.informOtherClients(client);

                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {

                job = data.l;
                if (job) {
                    dataController.mysqlConnection.query('DELETE FROM Jobs WHERE id = ?', job.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.job.informOtherClients(client);


                        }
                    });
                }
            }

        }, informOtherClients: function (clientController,client) {

            if (clientController.clients.length > 1) {

                //Send list of all Jobs to ohter clients
                dataController.mysqlConnection.query('SELECT * FROM Jobs', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var jobs = [];
                            for (var i = 0; i < rows.length; i++) {
                                jobs.push(dataController.job.convertFromSQL(rows[i]));
                            }
                            var clients = clientController.clients.filter(function (element) {
                                return (element.socket != client.socket)
                            });

                            clients.forEach(function (actClient) {

                                actClient.socket.emit('message', {t: dataController.job.messageType.updateOthers, l: jobs});

                            });

                        }
                    }
                });

            }

        }

    }

}

module.exports = dataController;