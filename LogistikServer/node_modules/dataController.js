/**
 * dataController
 *
 *
 *
 *
 * @date 21.11.14 - 12:26
 *
 */


dataController = {
    mysql: null,
    mysqlConnection: null,
    CryptoJS: null,
    init: function (preferences, CryptoJS) {

        //Load mysql
        this.mysql = require('mysql');
        //Connect to MySql database
        this.mysqlConnection = this.mysql.createConnection(preferences.mysql);
        this.mysqlConnection.connect(function (err) {
            if (err) throw err;
            console.log('Connected to MySql database');
        });

        this.CryptoJS = CryptoJS;

    },
    handleMessage: function (clientController, client, data) {

        console.log("Handle: Message " + data.t)

        if (data.t.substr(0, 1) == "l") {
            dataController.lieferant.handleMessage(clientController, client, data)
        } else if (data.t.substr(0, 1) == "t") {
            dataController.termin.handleMessage(clientController, client, data)
        } else if (data.t.substr(0, 1) == "n") {
            dataController.nachricht.handleMessage(clientController, client, data)
        } else if (data.t.substr(0, 1) == "a") {
            dataController.antwortNachricht.handleMessage(clientController, client, data)
        } else if (data.t.substr(0, 1) == "j") {
            dataController.job.handleMessage(clientController, client, data)
        } else if (data.t.substr(0, 1) == "m") {
            dataController.maerkte.handleMessage(clientController, client, data)

        } else if (data.t.substr(0, 1) == "s") {
            dataController.statistics.handleMessage(clientController, client, data)
        }


    },

    lieferant: {
        messageType: {
            login: "ll",
            getNewPin: "lgnp",
            getAll: "lga",
            create: "lc",
            update: "lu",
            delete: "ld",
            get: "lg",
            updateOthers: "luo"
        },
        handleMessage: function (clientController, client, data) {
            var lieferant;


            if (data.t == this.messageType.login) {

                dataController.mysqlConnection.query("SELECT * FROM Lieferanten WHERE PinSHA = ? ", data.p, function (err, rows, fields) {

                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        //Pin doesnt exists yet
                        if (rows && rows.length == 1) {
                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: rows[0]});
                        } else
                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: null});
                    }
                });


            } else if (data.t == this.messageType.getNewPin) {
                lieferant = data.l;
                if (lieferant) {

                    var generateNewPin = function () {

                        //Create Pin 4 digits
                        var pin = "" + (Math.floor(Math.random() * 9998) + 1);
                        var pad = "0000";
                        pin = pad.substring(0, pad.length - pin.length) + pin;

                        dataController.mysqlConnection.query("SELECT * FROM Lieferanten WHERE Pin = ? ", pin, function (err, rows, fields) {

                            if (err)
                                console.log("MYSQL ERROR: " + err);
                            else {
                                //Pin doesnt exists yet
                                if (rows && rows.length == 0) {

                                    lieferant.Pin = pin;
                                    lieferant.PinSHA = "" + dataController.CryptoJS.SHA3("dfjo58443pggd9gudf9" + pin, { outputLength: 512 });

                                    dataController.mysqlConnection.query("UPDATE Lieferanten SET ? WHERE id = ? ", [lieferant, lieferant.id], function (err, result) {
                                        if (err)
                                            console.log("MYSQL ERROR: " + err);
                                        else {

                                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: lieferant});

                                            dataController.lieferant.informOtherClients(clientController, client);

                                        }

                                    });

                                } else {
                                    generateNewPin();
                                }

                            }
                        });
                    }
                    generateNewPin();


                }

            } else if (data.t == this.messageType.getAll) {

                dataController.mysqlConnection.query('SELECT * FROM Lieferanten', function (err, rows, fields) {

                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {

                        if (rows) {

                            var lieferanten = rows;
                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: lieferanten});
                        }
                    }
                });

            } else if (data.t == this.messageType.create) {

                lieferant = data.l;
                if (lieferant) {
                    dataController.mysqlConnection.query('INSERT INTO Lieferanten SET ?', lieferant, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            dataController.lieferant.informOtherClients(clientController, client);


                        }
                    });
                }
            } else if (data.t == this.messageType.update) {
                lieferant = data.l;

                if (lieferant) {

                    dataController.mysqlConnection.query("UPDATE Lieferanten SET ? WHERE id = ? ", [lieferant, lieferant.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.lieferant.informOtherClients(clientController, client);

                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {

                lieferant = data.l;
                if (lieferant) {
                    dataController.mysqlConnection.query('DELETE FROM Lieferanten WHERE id = ?', lieferant.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.lieferant.informOtherClients(clientController, client);


                        }
                    });
                }
            }

        }, informOtherClients: function (clientController, client) {

            if (clientController.clients.length > 1) {

                //Send list of all Lieferanten to ohter clients
                dataController.mysqlConnection.query('SELECT * FROM Lieferanten', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var lieferanten = rows;

                            var clients = clientController.clients.filter(function (element) {
                                return (element.socket != client.socket)
                            });

                            clients.forEach(function (actClient) {
                                actClient.socket.emit('message', {t: dataController.lieferant.messageType.updateOthers, l: lieferanten});
                            });

                        }
                    }
                });

            }

        }

    },
    termin: {
        messageType: {
            getAll: "tga",
            getRange: "tgr",
            create: "tc",
            update: "tu",
            delete: "td",
            get: "tg",
            updateOthers: "tuo"
        },

        handleMessage: function (clientController, client, data) {

            var termin;

            if (data.t == this.messageType.getAll) {
                dataController.mysqlConnection.query('SELECT * FROM Termine', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var termine = rows;

                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: termine});
                        }
                    }
                });

            }else if (data.t == this.messageType.getRange) {

               var start = data.start;
               var end = data.end;


               dataController.mysqlConnection.query('SELECT * FROM Termine WHERE (RepeatDays = 0 AND StartMilli >= ? AND ((EndMilli <= ? AND EndMilli <> 0) OR (StartMilli <= ? AND EndMilli = 0 ))) OR (RepeatDays > 0)   ',[start,end,end], function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var termine = rows;

                             console.log(rows.length)
                            if(rows.length>0)
                             console.log(rows[0].Start)

                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: termine});
                        }
                    }
                });

            } else if (data.t == this.messageType.create) {

                termin = data.l;
                if (termin) {
                    dataController.mysqlConnection.query('INSERT INTO Termine SET ?', termin, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.termin.informOtherClients(clientController, client);

                        }
                    });
                }
            } else if (data.t == this.messageType.update) {
                termin = data.l;

                if (termin) {
                    dataController.mysqlConnection.query("UPDATE Termine SET ? WHERE id = ? ", [termin, termin.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.termin.informOtherClients(clientController, client);
                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {

                termin = data.l;
                if (termin) {
                    dataController.mysqlConnection.query('DELETE FROM Termine WHERE id = ?', termin.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.termin.informOtherClients(clientController, client);
                        }
                    });
                }
            }
        }, informOtherClients: function (clientController, client) {

            if (clientController.clients.length > 1) {

                //Send list of all termine to ohter clients
                dataController.mysqlConnection.query('SELECT * FROM Termine', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var termine = rows;

                            var clients = clientController.clients.filter(function (element) {
                                return (element.socket != client.socket)
                            });

                            clients.forEach(function (actClient) {

                                actClient.socket.emit('message', {t: dataController.termin.messageType.updateOthers, e: termine});

                            });


                        }
                    }
                });

            }

        }
    },

    nachricht: {
        messageType: {
            getAll: "nga",
            create: "nc",
            delete: "nd",
            updateOthers: "nuo"
        },
        maxNachrichten:1000,
        //Get all the Messages, joins messages and receipients
        getAllAdminNachrichten: function (callback) {
            if (!callback)
                return;




            dataController.mysqlConnection.query('SELECT * FROM Adminnachrichtgesendet ORDER BY datum DESC', function (err, rows, fields) {
                if (err)
                    console.log("MYSQL ERROR: " + err);
                else {

                    if (rows) {

                        rows = rows.slice(0,dataController.nachricht.maxNachrichten);


                        var getLieferanten = function (nachrichten, position) {

                           console.log(position+" >= "+dataController.nachricht.maxNachrichten);

                            if (position == nachrichten.length)
                                callback([]);
                            else {

                                dataController.mysqlConnection.query('SELECT * FROM Adminlieferantnachricht WHERE nachrichtenid = ?', nachrichten[position].id, function (err, rows, fields) {
                                    if (err)
                                        console.log("MYSQL ERROR: " + err);
                                    else {
                                        if (rows) {
                                            nachrichten[position].lieferanten = [];
                                            for (var i = 0; i < rows.length; i++) {
                                                nachrichten[position].lieferanten.push({lieferantid: rows[i].lieferantid, read: rows[i].read == 1 ? true : false});

                                            }

                                            if (position == nachrichten.length - 1) {
                                                callback(nachrichten)
                                            }
                                            else
                                                getLieferanten(nachrichten, position + 1);
                                        }
                                    }
                                });
                            }
                        }
                        getLieferanten(rows, 0);

                    }
                }
            });
        }, handleMessage: function (clientController, client, data) {

            var nachricht;

            if (data.t == this.messageType.getAll) {

                dataController.nachricht.getAllAdminNachrichten(function (nachrichten) {
                    client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: nachrichten});

                })

            } else if (data.t == this.messageType.create) {

                nachricht = data.n;
                if (nachricht) {

                    var sqlNachricht = JSON.parse(JSON.stringify(nachricht));
                    delete sqlNachricht.lieferanten

                    dataController.mysqlConnection.query('INSERT INTO Adminnachrichtgesendet SET ?', sqlNachricht, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            for (var i = 0; i < nachricht.lieferanten.length; i++) {
                                var lieferantId = nachricht.lieferanten[i].lieferantid;
                                var insertData = {lieferantid: lieferantId, nachrichtenid: nachricht.id};
                                dataController.mysqlConnection.query('INSERT INTO Adminlieferantnachricht SET ?', insertData, function (err, result) {
                                    if (err)
                                        console.log("MYSQL ERROR: " + err);
                                    else {

                                        dataController.nachricht.informOtherClients(clientController, client);

                                    }
                                });

                            }

                        }
                    });
                }
            } else if (data.t == this.messageType.delete) {

                nachricht = data.n;
                if (nachricht) {
                    dataController.mysqlConnection.query('DELETE FROM Adminnachrichtgesendet WHERE id = ?', nachricht.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            dataController.mysqlConnection.query('DELETE FROM Adminlieferantnachricht WHERE nachrichtenid = ?', nachricht.id, function (err, result) {
                                if (err)
                                    console.log("MYSQL ERROR: " + err);
                                else {

                                    dataController.nachricht.informOtherClients(clientController, client);

                                }
                            });
                        }
                    });
                }


            }
        }, informOtherClients: function (clientController, client) {

            if (clientController.clients.length > 1) {

                dataController.nachricht.getAllAdminNachrichten(function (nachrichten) {

                    var clients = clientController.clients.filter(function (element) {
                        return (element.socket != client.socket)
                    });

                    clients.forEach(function (actClient) {
                        actClient.socket.emit('message', {t: dataController.nachricht.messageType.updateOthers, n: nachrichten});
                    });

                })


            }

        }

    },
    antwortNachricht: {
        messageType: {
            getAll: "aga",
            update: "au",
            delete: "ad",
            updateOthers: "auo"
        },
        maxNachrichten:1000,
        getAllAdminNachrichten: function (callback) {
            if (!callback)
                return;
            dataController.mysqlConnection.query('SELECT * FROM Lieferantnachrichtgesendet  ORDER BY datum DESC', function (err, rows, fields) {
                if (err)
                    console.log("MYSQL ERROR: " + err);
                else {
                    if (rows) {

                        rows = rows.slice(0,dataController.antwortNachricht.maxNachrichten);
                        callback(rows);
                    }
                }
            });

        },
        handleMessage: function (clientController, client, data) {

            var nachricht;

            if (data.t == this.messageType.getAll) {
                dataController.antwortNachricht.getAllAdminNachrichten(function (nachrichten) {
                    client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: nachrichten});
                })

            } else if (data.t == this.messageType.update) {
                nachricht = data.a;
                if (nachricht) {

                    dataController.mysqlConnection.query("UPDATE Lieferantnachrichtgesendet SET ? WHERE id = ? ", [nachricht, nachricht.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.antwortNachricht.informOtherClients(clientController, client);
                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {


                nachricht = data.a;
                if (nachricht) {
                    dataController.mysqlConnection.query('DELETE FROM Lieferantnachrichtgesendet WHERE id = ?', nachricht.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.antwortNachricht.informOtherClients(clientController, client);
                        }
                    });
                }


            }
        }, informOtherClients: function (clientController, client) {

            if (clientController.clients.length > 1) {

                dataController.antwortNachricht.getAllAdminNachrichten(function (nachrichten) {

                    var clients = clientController.clients.filter(function (element) {
                        return (element.socket != client.socket)
                    });

                    clients.forEach(function (actClient) {
                        actClient.socket.emit('message', {t: dataController.antwortNachricht.messageType.updateOthers, a: nachrichten});
                    });

                })


            }

        }
    }, job: {
        messageType: {
            getAll: "jga",
            getTemplates:"jt",
            create: "jc",
            update: "ju",
            delete: "jd",
            get: "jg",
            updateOthers: "juo"
        },
        handleMessage: function (clientController, client, data) {
            var job;


            if (data.t == this.messageType.getAll) {


                dataController.mysqlConnection.query('SELECT * FROM Jobs', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var jobs = rows;

                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: jobs});
                        }
                    }
                });

            } else  if (data.t == this.messageType.getTemplates) {

                dataController.mysqlConnection.query('SELECT * FROM Jobs WHERE lieferanten_id = "'+ data.lid+'" AND NOT template_name = ""' , function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        var jobs = null;
                        if (rows) {
                            jobs = rows;
                        }
                        dataController.mysqlConnection.query('SELECT * FROM jobs WHERE lieferanten_id = "'+ data.lid +'" ORDER BY timestamp_start DESC LIMIT 1', function (err, rows, fields) {
                            if (err)
                                console.log("MYSQL ERROR: " + err);
                            else {
                                if (rows && rows.length == 1) {
                                    if (jobs) {
                                     jobs.unshift(rows[0]);
                                    }
                                    else{
                                        jobs = rows;
                                    }
                                    client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: jobs});
                                }
                                else{
                                    if (jobs) {
                                        client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: jobs});
                                    }
                                }
                            }
                        });
                    }
                });

            }
            else if (data.t == this.messageType.get) {

                var jobId = data.j;
                dataController.mysqlConnection.query('SELECT * FROM Jobs WHERE id = ? ', jobId, function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows && rows.length == 1) {
                            var job = rows[0];
                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: job});
                        }
                    }
                });

            } else if (data.t == this.messageType.create) {


                job = data.j;

                if (job) {
                    dataController.mysqlConnection.query('INSERT INTO Jobs SET ?', job, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {

                            dataController.job.informOtherClients(clientController, client);


                        }
                    });
                }
            } else if (data.t == this.messageType.update) {
                job = data.j;

                if (job) {

                    dataController.mysqlConnection.query("UPDATE Jobs SET ? WHERE id = ? ", [job, job.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.job.informOtherClients(clientController, client);

                        }

                    });
                }
            } else if (data.t == this.messageType.delete) {

                job = data.l;
                if (job) {
                    dataController.mysqlConnection.query('DELETE FROM Jobs WHERE id = ?', job.id, function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.job.informOtherClients(clientController, client);


                        }
                    });
                }
            }

        }, informOtherClients: function (clientController, client) {

            if (clientController.clients.length > 1) {

                //Send list of all Jobs to ohter clients
                dataController.mysqlConnection.query('SELECT * FROM Jobs', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var jobs = rows;

                            var clients = clientController.clients.filter(function (element) {
                                return (element.socket != client.socket)
                            });

                            clients.forEach(function (actClient) {

                                actClient.socket.emit('message', {t: dataController.job.messageType.updateOthers, l: jobs});

                            });

                        }
                    }
                });

            }

        }

    }, maerkte: {
        messageType: {
            getAll: "mga",
            update:"mu"
        },
        handleMessage: function (clientController, client, data) {
            var markt;

            if (data.t == this.messageType.getAll) {

                dataController.mysqlConnection.query('SELECT * FROM Maerkte', function (err, rows, fields) {
                    if (err)
                        console.log("MYSQL ERROR: " + err);
                    else {
                        if (rows) {

                            var maerkte = rows;

                            client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: maerkte});
                        }
                    }
                });

            } else if (data.t == this.messageType.update) {
                markt = data.m;
                if (markt) {

                    dataController.mysqlConnection.query("UPDATE Maerkte SET ? WHERE id = ? ", [markt, markt.id], function (err, result) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else {
                            dataController.job.informOtherClients(clientController, client);

                        }

                    });
                }
            }
        }
    },
    statistics: {
        messageType: {
            get: "sg"
        },
        handleMessage: function (clientController, client, data) {


            if (data.t == this.messageType.get) {

                var statistics = {};

                //Statistc Methods---------------------

                var countBesuche = function (statistics, callback) {
                    dataController.mysqlConnection.query('SELECT COUNT(*) AS count FROM Jobs WHERE besuch = 1', function (err, rows, fields) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else if (rows)
                            statistics.besuche = rows[0].count;
                        callback(statistics)
                    });
                }

                var countBestellung = function (statistics, callback) {
                    dataController.mysqlConnection.query('SELECT COUNT(*) AS count FROM Jobs WHERE bestellung = 1', function (err, rows, fields) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else if (rows)
                            statistics.bestellungen = rows[0].count;
                        callback(statistics)
                    });
                }


                var countVerraumung = function (statistics, callback) {
                    dataController.mysqlConnection.query('SELECT COUNT(*) AS count FROM Jobs WHERE verraeumung = 1', function (err, rows, fields) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else if (rows)
                            statistics.verraeumungen = rows[0].count;
                        callback(statistics)
                    });
                }

                var countAustausch = function (statistics, callback) {
                    dataController.mysqlConnection.query('SELECT COUNT(*) AS count FROM Jobs WHERE austausch = 1', function (err, rows, fields) {
                        if (err)
                            console.log("MYSQL ERROR: " + err);
                        else if (rows)
                            statistics.austausche = rows[0].count;
                        callback(statistics)
                    });
                }


                //Chain Methods


                countBesuche(statistics,
                    function (statistics) {
                        countBestellung(statistics,
                            function (statistics) {
                                countVerraumung(statistics,
                                    function (statistics) {
                                        countAustausch(statistics,
                                            //Return statistics
                                            function (statistics) {
                                                client.socket.emit('message', {t: "cb", callback: data.callback, cbdata: statistics});
                                            })
                                    })
                            })
                    });


            }
        }
    }



}

module.exports = dataController;